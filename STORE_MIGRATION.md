# Store Management System Migration

## Overview
This migration updates the CAP store system to use Firestore collections instead of hardcoded items, and consolidates all orders into a single `orders` collection.

## Database Schema Changes

### New Collections

#### 1. `storeItems` Collection
Stores all CAP store items dynamically.

```typescript
{
  id: string;                    // Auto-generated by Firestore
  title: string;                 // Item title
  description: string;           // Item description
  pointsRequired: number;        // Points needed to unlock
  icon: string;                  // Emoji icon
  type: "letter" | "book" | "merchandise" | "other";
  imageUrl?: string;             // Optional image path (e.g., "/assets/book.jpg")
  isActive: boolean;             // Whether item is active
  isPaused: boolean;             // Whether item is temporarily paused
  createdBy: string;             // Admin UID who created it
  createdAt: Timestamp;
  updatedAt: Timestamp;
}
```

#### 2. `orders` Collection (Replaces `bookOrders`)
Stores all orders for any store item.

```typescript
{
  id: string;                    // Auto-generated by Firestore
  userId: string;                // User who placed the order
  userName: string;              // User's display name
  userEmail: string;             // User's email
  itemId: string;                // Reference to storeItems doc ID
  itemTitle: string;             // Item title (denormalized)
  pointsUsed: number;            // Points used for this order
  status: "pending" | "processing" | "shipped" | "delivered" | "cancelled";
  shippingAddress: {
    name: string;
    email: string;
    phone: string;
    addressLine1: string;
    addressLine2?: string;
    city: string;
    state: string;
    pincode: string;
  };
  createdAt: Timestamp;
  updatedAt: Timestamp;
}
```

## Migration Steps

### Step 1: Run the Migration Script

The migration script will create the initial store items in Firestore.

**Option A: Using ts-node (recommended)**
```bash
npm install -g ts-node
npm install --save-dev @types/node
ts-node scripts/migrate-store-items.ts
```

**Option B: Using Node.js directly**
```bash
# First compile TypeScript
npx tsc scripts/migrate-store-items.ts --module commonjs --target ES2020
# Then run
node scripts/migrate-store-items.js
```

**Option C: Manual Creation via Admin Panel**
After deployment, admins can add items manually through the admin panel at `/admin/store`.

### Step 2: Update Firestore Security Rules

Add these rules to your `firestore.rules`:

```
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Store Items - Public read, admin write
    match /storeItems/{itemId} {
      allow read: if true;
      allow create, update, delete: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
    }
    
    // Orders - Users can read their own orders, create new orders, admins can read/update all
    match /orders/{orderId} {
      allow read: if request.auth != null && 
        (resource.data.userId == request.auth.uid || 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin");
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
    }
    
    // ... your other rules ...
  }
}
```

Deploy the rules:
```bash
firebase deploy --only firestore:rules
```

### Step 3: Migrate Existing Orders (Optional)

If you have existing orders in the `bookOrders` collection, you can migrate them to the new `orders` collection using the Firebase Console or a script.

**Example migration query (run in Firebase Console):**
1. Go to Firestore Database
2. Export `bookOrders` collection
3. Transform the data to match the new schema
4. Import to `orders` collection

**Or create a one-time migration script:**
```typescript
// scripts/migrate-orders.ts
import { db } from "./firebase-config";
import { collection, getDocs, addDoc } from "firebase/firestore";

async function migrateOrders() {
  const oldOrders = await getDocs(collection(db, "bookOrders"));
  
  for (const doc of oldOrders.docs) {
    const oldData = doc.data();
    
    // Transform to new schema
    const newOrder = {
      userId: oldData.userId,
      userName: oldData.userName,
      userEmail: oldData.email,
      itemId: oldData.itemId,
      itemTitle: oldData.itemTitle,
      pointsUsed: oldData.pointsRequired || oldData.pointsUsed,
      status: oldData.status || "pending",
      shippingAddress: {
        name: oldData.userName,
        email: oldData.email,
        phone: oldData.phone,
        addressLine1: oldData.addressLine1,
        addressLine2: oldData.addressLine2 || "",
        city: oldData.city,
        state: oldData.state,
        pincode: oldData.pincode,
      },
      createdAt: oldData.orderDate ? new Date(oldData.orderDate) : new Date(),
      updatedAt: new Date(),
    };
    
    await addDoc(collection(db, "orders"), newOrder);
    console.log(`Migrated order: ${doc.id}`);
  }
  
  console.log("Migration complete!");
}

migrateOrders();
```

## Features

### Admin Panel (`/admin/store`)

Admins can now:
- ✅ Create new store items with custom details
- ✅ Edit existing items
- ✅ Pause/Resume items (keeps them in database but hides from users)
- ✅ Delete items
- ✅ View all orders across all users
- ✅ Update order status (pending → processing → shipped → delivered/cancelled)
- ✅ View detailed shipping information for each order

### User Store Page (`/store`)

Users can now:
- ✅ View dynamically loaded store items
- ✅ See real-time order status (not just "ORDERED", but actual status)
- ✅ Place orders with automatic form submission to new schema
- ✅ View items with custom images or emoji icons

## Order Status Flow

1. **pending** - Order just placed, awaiting admin review
2. **processing** - Order confirmed, being prepared
3. **shipped** - Item has been shipped to user
4. **delivered** - Item successfully delivered
5. **cancelled** - Order cancelled by admin or user

## Testing

1. **Test Admin Panel:**
   - Log in as admin
   - Go to `/admin/store`
   - Create a test item
   - Verify it appears in the store
   - Edit, pause, and delete the item

2. **Test User Store:**
   - Log in as regular user with enough points
   - Go to `/store`
   - Verify items load from Firestore
   - Place a test order
   - Verify order appears in admin panel

3. **Test Order Status Updates:**
   - As admin, update order status
   - As user, view order and verify status displays correctly

## Troubleshooting

### Items not showing in store
- Check Firestore rules allow read access
- Verify items have `isActive: true` and `isPaused: false`
- Check browser console for errors

### Can't create items as admin
- Verify user has `role: "admin"` in Firestore users collection
- Check Firestore rules allow admin write access

### Orders not saving
- Check Firestore rules for orders collection
- Verify form validation passes
- Check browser console for errors

## Future Enhancements

- [ ] Image upload for store items
- [ ] Order tracking with notifications
- [ ] Email notifications on order status changes
- [ ] User order history page
- [ ] Inventory management (quantity limits)
- [ ] Order export to CSV
- [ ] Analytics dashboard for orders
